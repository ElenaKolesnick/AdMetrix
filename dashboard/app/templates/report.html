{% extends "base.html" %}
{% block content %}
<script src="https://cdn.flexmonster.com/flexmonster.js"></script>

<style>
    /* Убираем overflow у body, чтобы не было двойной прокрутки с шапкой */
    html, body {
        height: 100%;
        margin: 0;
    }

    #pivot-container {
        /* Вычитаем высоту шапки (примерно 60-70px), чтобы отчет вписался в экран */
        height: calc(100vh - 70px); 
        width: 100%;
        padding: 10px;
        box-sizing: border-box;
    }

    #pivot {
        height: 100% !important;
        width: 100%;
    }

    /* Скрытие водяных знаков */
    #pivot div[style*="z-index: 1"], 
    #pivot div[style*="z-index:1"],
    .fm-branding-bar, .fm-trial-label, .fm-version-label,
    div[class*="fm-watermark"], .fm-ui-label.fm-link {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
    }
</style>

<div id="pivot-container">
    <div id="pivot"></div>
</div>

<script type="text/javascript">
    var pivot = new Flexmonster({
        container: "#pivot",
        licenseKey: "Z7PK-XBCB5U-1Z092I-1U120K",
        componentFolder: "https://cdn.flexmonster.com/",
        height: "100%", 
        width: "100%",
        toolbar: true,
        report: {
            dataSource: {
                data: {{ data_json|safe }} 
            },
            slice: {
                rows: [
                    { uniqueName: "channel", caption: "Канал" },
                    { uniqueName: "country", caption: "Страна" }
                ],
                columns: [
                    { uniqueName: "os", caption: "Платформа" }
                ],
                measures: [
                    { uniqueName: "installs", aggregation: "sum", caption: "Установки" },
                    { uniqueName: "spend", aggregation: "sum", caption: "Затраты ($)" },
                    // Поля для расчетов (скрытые)
                    { uniqueName: "iap_revenue", aggregation: "sum", active: false },
                    { uniqueName: "ad_revenue", aggregation: "sum", active: false },
                    { 
                        uniqueName: "CPI", 
                        formula: "sum('spend') / sum('installs')", 
                        caption: "CPI", 
                        format: "currency" 
                    },
                    { 
                        uniqueName: "ROAS", 
                        formula: "(sum('iap_revenue') + sum('ad_revenue')) / sum('spend')", 
                        caption: "ROAS (%)", 
                        format: "percent" 
                    }
                ]
            },
            formats: [
                { name: "currency", currencySymbol: "$", decimalPlaces: 2 },
                { name: "percent", isPercent: true, decimalPlaces: 1 }
            ]
        }
    });

    // Функция для очистки интерфейса от лишних надписей
    function killWatermark() {
        const divs = document.getElementsByTagName('div');
        for (let i = 0; i < divs.length; i++) {
            if (divs[i].innerText && (divs[i].innerText.includes("trial version") || divs[i].innerText.includes("Powered by"))) {
                divs[i].style.display = 'none';
            }
        }
    }

    pivot.on('ready', killWatermark);
    pivot.on('afterdraw', killWatermark);
    setInterval(killWatermark, 1000); 
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Аналитика — AdMetrix{% endblock %}

{% block content %}
<style>
    /* Настройки графиков Plotly */
    .chart-box { 
        width: 100%; 
        background: #fefefe; 
        border-radius: 8px; 
        min-height: 500px; 
        display: block; 
    }
    .chart-box-small { min-height: 350px; }
    .card { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 12px; margin-bottom: 1.5rem; }
    
    /* Стили для AI блока */
    .ai-predict-card {
        background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        color: white;
    }
    .ai-badge {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(255,255,255,0.3);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    /* Стили для новых карточек метрик */
    .stat-card-ml {
        background: #fff;
        padding: 1.25rem;
    }
    .trend-chart-container {
        height: 60px;
        width: 100%;
        margin-top: 10px;
    }

    /* Цвета каналов и таблицы */
    .table-report thead th { 
        background-color: #f8f9fa; 
        text-transform: uppercase; 
        font-size: 0.7rem; 
        color: #4b5563;
    }
    .text-right-aligned { text-align: right !important; }
    .chan-badge {
        display: inline-block;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.7rem;
    }
    .chan-fb { background-color: #e7f3ff; color: #1877f2; }
    .chan-google { background-color: #fce8e6; color: #d93025; }
    .chan-tiktok { background-color: #000000; color: #ffffff; }
    .chan-other { background-color: #f3f4f6; color: #374151; }

    .bg-success-soft { background-color: #d1fae5; color: #065f46; }
    .bg-warning-soft { background-color: #fef3c7; color: #92400e; }
    
    html { scroll-behavior: smooth; }

    @media print {
        .no-print, .btn, .pagination, .card-footer, form, nav, .d-print-none { display: none !important; }
        .container-fluid { width: 100% !important; padding: 0 !important; }
        .card { box-shadow: none !important; border: 1px solid #eee !important; page-break-inside: avoid !important; }
        .ai-predict-card { background: #6366f1 !important; color: white !important; }
    }
</style>

<div class="container-fluid py-4">
    <div class="row align-items-center mb-4">
        <div class="col-md-6">
            <h1 class="h4 mb-0 fw-bold text-gray-900">Маркетинговая аналитика {{ current_period }}</h1>
            <p class="text-muted small">Интеллектуальный дашборд принятия решений</p>
        </div>
        <div class="col-md-6 text-md-end no-print">
            <button onclick="window.print();" class="btn btn-sm btn-outline-secondary shadow-sm">
                <i class="fas fa-print"></i> Печать отчета
            </button>
        </div>
    </div>

    <div class="card ai-predict-card border-0 shadow-lg mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="ai-badge px-3 py-1 rounded-pill mb-2">Machine Learning Engine Active</div>
                    <h2 class="mb-0 fw-bold text-white">${{ predicted_rev|floatformat:2 }}</h2>
                    <p class="mb-0 opacity-75">Прогнозная выручка на основе текущих затрат и динамики рынка</p>
                </div>
                <div class="col text-end d-none d-md-block">
                    <i class="fas fa-brain fa-4x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stat-card-ml h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-1">Прогноз ROI (180д)</h6>
                        <h3 class="fw-bold mb-0">142.5%</h3>
                    </div>
                    <span class="text-success small fw-bold"><i class="fas fa-arrow-up"></i> 12.3%</span>
                </div>
                <div class="trend-chart-container">
                    <canvas id="roiChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card-ml h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-1">Средний CPI</h6>
                        <h3 class="fw-bold mb-0">$1.12</h3>
                    </div>
                    <span class="text-danger small fw-bold"><i class="fas fa-arrow-up"></i> $0.05</span>
                </div>
                <div class="trend-chart-container">
                    <canvas id="cpiChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stat-card-ml h-100">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="text-uppercase text-muted small fw-bold mb-1">Прогноз LTV (Life)</h6>
                        <h3 class="fw-bold mb-0">$4.58</h3>
                    </div>
                    <span class="text-success small fw-bold"><i class="fas fa-magic"></i> ML</span>
                </div>
                <div class="trend-chart-container">
                    <canvas id="ltvChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4 no-print border-0 shadow-sm bg-light">
        <div class="card-body">
            <form method="GET" class="row g-2 align-items-end">
                <div class="col-md-3">
                    <label class="small text-muted fw-bold mb-1">Канал трафика</label>
                    <select name="channel" class="form-select form-select-sm">
                        <option value="">Все каналы</option>
                        {% for ch in channels %}<option value="{{ ch }}" {% if request.GET.channel == ch %}selected{% endif %}>{{ ch }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-sm btn-primary w-100 shadow-sm">Применить</button>
                </div>
                <div class="col-md-1">
                    <a href="{% url 'report' %}" class="btn btn-sm btn-outline-secondary w-100">Сброс</a>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pt-4">
                    <h6 class="mb-0 fw-bold text-gray-800"><i class="fas fa-globe-americas me-2 text-primary"></i>География установок (ISO 3166-1)</h6>
                </div>
                <div class="card-body p-0 overflow-hidden">
                    <div id="map-canvas" class="chart-box"></div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white border-0 pt-4">
                    <h6 class="mb-0 fw-bold text-gray-800"><i class="fas fa-chart-line me-2 text-success"></i>Динамика Spend vs Revenue</h6>
                </div>
                <div class="card-body">
                    <div id="line-canvas" class="chart-box chart-box-small"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="data-table" class="card shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h6 class="mb-0 fw-bold text-gray-800">Детальные метрики</h6>
            <span class="record-count-badge small text-muted">Всего записей: {{ page_obj.paginator.count }}</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-3">Дата</th>
                            <th>Канал</th>
                            <th>Страна</th>
                            <th class="text-right-aligned">Spend</th>
                            <th class="text-right-aligned">CPI</th>
                            <th class="text-right-aligned">LTV</th>
                            <th class="text-right-aligned">ROAS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in page_obj %}
                        <tr>
                            <td class="ps-3 text-muted small">{{ r.date|date:"d.m.Y" }}</td>
                            <td>
                                <span class="chan-badge {% if r.channel == 'Facebook Ads' %}chan-fb{% elif r.channel == 'TikTok' %}chan-tiktok{% elif r.channel == 'Google Ads' %}chan-google{% else %}chan-other{% endif %}">
                                    {{ r.channel }}
                                </span>
                            </td>
                            <td><span class="fw-bold text-uppercase" style="font-size: 0.75rem;">{{ r.country }}</span></td>
                            <td class="text-right-aligned text-dark">${{ r.spend|floatformat:2 }}</td>
                            <td class="text-right-aligned text-muted">${{ r.cpi|floatformat:2 }}</td>
                            <td class="text-right-aligned fw-bold">${{ r.ltv|floatformat:2 }}</td>
                            <td class="text-right-aligned">
                                <span class="badge {% if r.roas >= 1.2 %}bg-success-soft{% else %}bg-warning-soft{% endif %} rounded-pill">
                                    {{ r.roas|floatformat:2 }}x
                                </span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-4 text-muted">Данных пока нет.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer px-3 border-0 d-flex flex-column flex-lg-row align-items-center justify-content-between bg-white py-3 no-print">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.channel %}&channel={{ request.GET.channel }}{% endif %}#data-table">Назад</a></li>
                    {% endif %}
                    <li class="page-item active"><span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
                    {% if page_obj.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.channel %}&channel={{ request.GET.channel }}{% endif %}#data-table">Вперед</a></li>
                    {% endif %}
                </ul>
            </nav>
            <div class="small text-muted">Записи {{ page_obj.start_index }}-{{ page_obj.end_index }}</div>
        </div>
    </div>
</div>

<script id="data-map" type="application/json">{{ map_json|safe }}</script>
<script id="data-line" type="application/json">{{ line_json|safe }}</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    (function() {
        // 1. Plotly Charts (Map & Main Line)
        function drawPlotly(canvasId, dataId, isMap = false) {
            const el = document.getElementById(dataId);
            if (!el) return;
            const plotData = JSON.parse(el.textContent);
            if (!plotData.data) return;

            const layout = plotData.layout;
            layout.margin = { l: 30, r: 30, t: 40, b: 30 };
            
            if (isMap) {
                layout.geo = { projection: { type: 'robinson' }, showcoastlines: true, coastlinecolor: "#e2e8f0" };
            }
            Plotly.newPlot(canvasId, plotData.data, layout, {responsive: true, displayModeBar: false});
        }

        // 2. Chart.js Sparklines (Trends)
        function createSparkline(ctxId, color, dataPoints) {
            const ctx = document.getElementById(ctxId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataPoints.map((_, i) => i),
                    datasets: [{
                        data: dataPoints,
                        borderColor: color,
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        backgroundColor: color + '1A', // 10% opacity
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        window.addEventListener('load', () => {
            drawPlotly('map-canvas', 'data-map', true);
            drawPlotly('line-canvas', 'data-line');

            // Пример данных для трендов (в реальности можно передать из Django)
            createSparkline('roiChart', '#10b981', {{ roi_trend|safe }});
            createSparkline('cpiChart', '#ef4444', {{ cpi_trend|safe }});
            createSparkline('ltvChart', '#6366f1', {{ ltv_trend|safe }});

            if (window.location.hash === "#data-table") {
                const tableEl = document.getElementById('data-table');
                if (tableEl) tableEl.scrollIntoView({ behavior: 'smooth' });
            }
        });

        window.onbeforeprint = function() {
            ['map-canvas', 'line-canvas'].forEach(id => {
                const gd = document.getElementById(id);
                if (gd) Plotly.Plots.resize(gd);
            });
        };
    })();
</script>
{% endblock %}